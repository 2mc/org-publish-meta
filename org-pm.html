<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Org-publish-meta: Easy projects for Org-mode</title>
<!-- 2013-12-30 Mon 00:34 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="I Z" />
<link href="./static/bootstrap.min.css" rel="stylesheet" media="screen">
<link href="./static/worg.min.css" rel="stylesheet" type="text/css">
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="./"> UP </a>
 |
 <a accesskey="H" href="./"> HOME </a>
</div><div id="content">
<h1 class="title">Org-publish-meta: Easy projects for Org-mode</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">Variables</a>
<ul>
<li><a href="#sec-1-1">org-pm-project-data-file-path</a></li>
<li><a href="#sec-1-2">org-pm-files</a></li>
<li><a href="#sec-1-3">org-pm-project-def-duplicates</a></li>
<li><a href="#sec-1-4">org-pm-auto-parse</a></li>
<li><a href="#sec-1-5">org-pm-auto-copy</a></li>
<li><a href="#sec-1-6">org-pm-project-template-file-name</a></li>
<li><a href="#sec-1-7">org-pm-default-project-name</a></li>
<li><a href="#sec-1-8">org-pm-default-project-org-folder</a></li>
<li><a href="#sec-1-9">org-pm-default-project-html-folder</a></li>
<li><a href="#sec-1-10">org-pm-default-project-plist</a></li>
</ul>
</li>
<li><a href="#sec-2">Auxiliary functions</a>
<ul>
<li><a href="#sec-2-1">Get header properties</a></li>
<li><a href="#sec-2-2">Get drawer contents</a></li>
<li><a href="#sec-2-3">Comment out the rest of a section following a comment line</a></li>
<li><a href="#sec-2-4">Functions for adding, removing and replacing elements in a-lists</a></li>
<li><a href="#sec-2-5">org-pm-make-default-project-alist</a></li>
<li><a href="#sec-2-6">org-pm-add-project-file</a></li>
<li><a href="#sec-2-7">org-pm-remove-project-file</a></li>
<li><a href="#sec-2-8">org-pm-add-project-to-file-header</a></li>
<li><a href="#sec-2-9">org-pm-get-section-projects</a></li>
<li><a href="#sec-2-10">org-pm-edit-project-template</a></li>
<li><a href="#sec-2-11">org-pm-edit-saved-project-data</a></li>
<li><a href="#sec-2-12">org-pm-show-project-definition-section</a></li>
<li><a href="#sec-2-13">org-pm-make-project-template</a></li>
<li><a href="#sec-2-14">Providing relative paths to root of published project</a></li>
<li><a href="#sec-2-15">Customizing the heading of table of contents</a></li>
</ul>
</li>
<li><a href="#sec-3">Setup auto-parse and auto-copy</a></li>
<li><a href="#sec-4">Main functions and commands</a>
<ul>
<li><a href="#sec-4-1">org-pm-do-auto / org-pm-dont-auto</a></li>
<li><a href="#sec-4-2">org-pm-load-all-project-data</a></li>
<li><a href="#sec-4-3">org-pm-save-all-project-data</a></li>
<li><a href="#sec-4-4">org-pm-reset-project-list</a></li>
<li><a href="#sec-4-5">org-pm-make-projects</a></li>
<li><a href="#sec-4-6">org-pm-parse-project-def</a></li>
<li><a href="#sec-4-7">org-pm-check-add-project</a></li>
<li><a href="#sec-4-8">org-pm-add-file-to-project:</a></li>
<li><a href="#sec-4-9">query-make-folder</a></li>
<li><a href="#sec-4-10">org-pm-remove-file-from-project:</a></li>
<li><a href="#sec-4-11">org-pm-add-component-to-project</a></li>
<li><a href="#sec-4-12">org-pm-remove-component-from-project</a></li>
<li><a href="#sec-4-13">org-pm-copy-components-to-projects</a></li>
<li><a href="#sec-4-14">org-pm-publish: Select a project to publish from the projects targeted by current buffer.</a></li>
<li><a href="#sec-4-15">org-pm-enable-auto:</a></li>
<li><a href="#sec-4-16">org-pm-disable-auto:</a></li>
<li><a href="#sec-4-17">org-pm-list-dupicate-project-defs</a></li>
<li><a href="#sec-4-18">org-pm-list-project-defs</a>
<ul>
<li><a href="#sec-4-18-1">org-pm-search-link</a></li>
</ul>
</li>
<li><a href="#sec-4-19">pm/edit-duplicate-project-def</a></li>
</ul>
</li>
<li><a href="#sec-5">Keyboard shortcuts</a></li>
<li><a href="#sec-6">Cleaning up duplicate links and dead projects+files</a></li>
</ul>
</div>
</div>
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">Variables</h2>
<div class="outline-text-2" id="text-1">
</div>

<div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1"><a id="ID-A71224C0-989C-419B-A7B6-2B0CEC64CEE7" name="ID-A71224C0-989C-419B-A7B6-2B0CEC64CEE7"></a>org-pm-project-data-file-path</h3>
<div class="outline-text-3" id="text-1-1">

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #728a05;">defvar</span> <span style="color: #2075c7;">org-pm-project-data-file-path</span>
  (<span style="color: #728a05;">let</span> ((home (file-truename <span style="color: #259185;">"~/.emacs.d"</span>)))
      (<span style="color: #728a05;">cond</span>
       ((file-exists-p home)
        (setq home (concat home <span style="color: #259185;">"/savefile"</span>))
        (<span style="color: #728a05;">unless</span> (file-exists-p home) (make-directory home))
        (concat home <span style="color: #259185;">"/org-pm-project.data.el"</span>))
       (t (concat home <span style="color: #259185;">"/.org-pm-project.data.el"</span>))))
  <span style="color: #465a61; font-style: italic;">"Path of file for storing org-publish-project-alist and</span>
<span style="color: #465a61; font-style: italic;">org-pm-files.  If nil, the path is deduced from the existence</span>
<span style="color: #465a61; font-style: italic;">of .emacs.d folder in user's home directory.</span>
<span style="color: #465a61; font-style: italic;">If .emacs.d exists, use ~/.emacs.d/savefile/org-publish-project-alist</span>
<span style="color: #465a61; font-style: italic;">else use ~/.org-publish-project-alist.</span>
<span style="color: #465a61; font-style: italic;">Create savefile folder if it does not exist."</span>)
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2"><a id="ID-A8ABC239-E74B-4654-9850-53C8521E50BA" name="ID-A8ABC239-E74B-4654-9850-53C8521E50BA"></a>org-pm-files</h3>
<div class="outline-text-3" id="text-1-2">

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #728a05;">defvar</span> <span style="color: #2075c7;">org-pm-files</span> nil
<span style="color: #465a61; font-style: italic;">"List of files to be copied to projects.</span>
<span style="color: #465a61; font-style: italic;">For each file, store a list starting with the full path of the file, and</span>
<span style="color: #465a61; font-style: italic;">followed by the list of projects specified in the file</span>
<span style="color: #465a61; font-style: italic;">or any of its sections:</span>
<span style="color: #465a61; font-style: italic;">  (full-path-of-file project1 project2 ...)</span>
<span style="color: #465a61; font-style: italic;">Function org-pm-register-project-components scans a file, creates its list</span>
<span style="color: #465a61; font-style: italic;">and puts it in org-pm-files.</span>
<span style="color: #465a61; font-style: italic;">Function org-pm-copy-to-project searches through all lists in org-pm-files,</span>
<span style="color: #465a61; font-style: italic;">collects the list of files that belong to a project,</span>
<span style="color: #465a61; font-style: italic;">parses each file to find which components should be copied,</span>
<span style="color: #465a61; font-style: italic;">and copies the found components to the project."</span>)
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-1-3" class="outline-3">
<h3 id="sec-1-3">org-pm-project-def-duplicates</h3>
<div class="outline-text-3" id="text-1-3">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #728a05;">defvar</span> <span style="color: #2075c7;">org-pm-project-def-duplicates</span> nil
  <span style="color: #465a61; font-style: italic;">"List of links to files/sections which contains project definitions</span>
<span style="color: #465a61; font-style: italic;">that were overwritten because another definition with the same name was found.</span>
<span style="color: #465a61; font-style: italic;">Auto-saved together with org-publish-project-alist and org-pm-files.</span>
<span style="color: #465a61; font-style: italic;">Used to create org-mode buffer with links to these locations.</span>
<span style="color: #465a61; font-style: italic;">See functions:</span>
<span style="color: #465a61; font-style: italic;">- org-pm-check-add-project</span>
<span style="color: #465a61; font-style: italic;">- org-pm-list-dupicate-project-defs</span>
<span style="color: #465a61; font-style: italic;">- org-pm-list-project-defs</span>
<span style="color: #465a61; font-style: italic;">- pm/edit-duplicate-project-def"</span>
)
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-1-4" class="outline-3">
<h3 id="sec-1-4"><a id="ID-03CF07FC-5FD7-46C6-BE11-74C3D339A315" name="ID-03CF07FC-5FD7-46C6-BE11-74C3D339A315"></a>org-pm-auto-parse</h3>
<div class="outline-text-3" id="text-1-4">

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #728a05;">defvar</span> <span style="color: #2075c7;">org-pm-auto-parse</span> t
  <span style="color: #465a61; font-style: italic;">"If not nil, automatically parse a org-mode buffer</span>
<span style="color: #465a61; font-style: italic;"> for org-pm data before saving it."</span>)
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-1-5" class="outline-3">
<h3 id="sec-1-5"><a id="ID-3AF37A0C-F14A-41A3-B477-5B12696315BE" name="ID-3AF37A0C-F14A-41A3-B477-5B12696315BE"></a>org-pm-auto-copy</h3>
<div class="outline-text-3" id="text-1-5">

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #728a05;">defvar</span> <span style="color: #2075c7;">org-pm-auto-copy</span> 'on-save
<span style="color: #465a61; font-style: italic;">"If not nil, automatically copy file components to a project to the</span>
<span style="color: #465a61; font-style: italic;">project's source folder before publishing."</span>)
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-1-6" class="outline-3">
<h3 id="sec-1-6"><a id="ID-9D5B4E5D-90E1-4F32-842D-620B262665AF" name="ID-9D5B4E5D-90E1-4F32-842D-620B262665AF"></a>org-pm-project-template-file-name</h3>
<div class="outline-text-3" id="text-1-6">

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #728a05;">defvar</span> <span style="color: #2075c7;">org-pm-project-template-file-name</span>
  (concat (file-name-directory (or load-file-name (buffer-file-name)))
          <span style="color: #259185;">"org-pm-project-template.org"</span>)
<span style="color: #465a61; font-style: italic;">"Full path of file containing template of project definition for</span>
<span style="color: #465a61; font-style: italic;">projects generated automatically with org-pm-make-project-template.</span>
<span style="color: #465a61; font-style: italic;">The path is initialized at code loading time by function org-pm-init-project-template-na</span><span style="color: #706f6f; background-color: #042028;">me.</span>
<span style="color: #465a61; font-style: italic;">org-pm-make-project-template uses it to make project templates."</span>)
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-1-7" class="outline-3">
<h3 id="sec-1-7"><a id="ID-3C9E0229-923D-4527-B2FE-903792AA5452" name="ID-3C9E0229-923D-4527-B2FE-903792AA5452"></a>org-pm-default-project-name</h3>
<div class="outline-text-3" id="text-1-7">

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #728a05;">defvar</span> <span style="color: #2075c7;">org-pm-default-project-name</span> <span style="color: #259185;">"org_pm_default"</span>
<span style="color: #465a61; font-style: italic;">"Name of default, auto-generated project."</span>)
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-1-8" class="outline-3">
<h3 id="sec-1-8"><a id="ID-3475B9CF-FDDF-4760-8CF1-FE22DC2AA589" name="ID-3475B9CF-FDDF-4760-8CF1-FE22DC2AA589"></a>org-pm-default-project-org-folder</h3>
<div class="outline-text-3" id="text-1-8">

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #728a05;">defvar</span> <span style="color: #2075c7;">org-pm-default-project-org-folder</span> <span style="color: #259185;">"~/pm-org"</span>
<span style="color: #465a61; font-style: italic;">"Path of folder for source files of default project."</span>)
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-1-9" class="outline-3">
<h3 id="sec-1-9"><a id="ID-92AFE11D-6A08-4D77-A2E9-BF0A196271F8" name="ID-92AFE11D-6A08-4D77-A2E9-BF0A196271F8"></a>org-pm-default-project-html-folder</h3>
<div class="outline-text-3" id="text-1-9">

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #728a05;">defvar</span> <span style="color: #2075c7;">org-pm-default-project-html-folder</span> <span style="color: #259185;">"~/pm-html"</span>
  <span style="color: #465a61; font-style: italic;">"Path of folder for html (published website) files of default project."</span>)
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-1-10" class="outline-3">
<h3 id="sec-1-10"><a id="ID-7539D61D-95E4-4308-B1C4-F86669E921B7" name="ID-7539D61D-95E4-4308-B1C4-F86669E921B7"></a>org-pm-default-project-plist</h3>
<div class="outline-text-3" id="text-1-10">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #728a05;">defvar</span> <span style="color: #2075c7;">org-pm-default-project-plist</span>
  '(
    <span style="color: #728a05;">:base-extension</span> <span style="color: #259185;">"org"</span>
    <span style="color: #728a05;">:recursive</span> t
    <span style="color: #728a05;">:publishing-function</span> org-publish-org-to-html
    <span style="color: #728a05;">:headline-levels</span> 5
    <span style="color: #728a05;">:auto-preamble</span> t
  )
<span style="color: #465a61; font-style: italic;">"The defalt properties for publishing a project with html.</span>
<span style="color: #465a61; font-style: italic;">Used to provide initial contents when creating a project plist in</span>
<span style="color: #465a61; font-style: italic;">org-pm-make-default-project-plist. "</span>
)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">Auxiliary functions</h2>
<div class="outline-text-2" id="text-2">
</div>

<div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1">Get header properties</h3>
<div class="outline-text-3" id="text-2-1">

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #728a05;">defun</span> <span style="color: #2075c7;">org-get-header-property</span> (property <span style="color: #a57705;">&amp;optional</span> all)
  <span style="color: #465a61; font-style: italic;">"Get property from buffer variable.  Returns only fist match except if ALL is defined.</span>
<span style="color: #465a61; font-style: italic;">NOTE: Also works if editing subtree narrowed or in separate narrowed buffer. "</span>
  (<span style="color: #728a05;">with-current-buffer</span>
      (current-buffer)
    (<span style="color: #728a05;">save-excursion</span>
      (<span style="color: #728a05;">save-restriction</span>
        (<span style="color: #728a05;">save-match-data</span>
          (widen)
          (goto-char (point-min))
          (<span style="color: #728a05;">let</span> (values)
            (<span style="color: #728a05;">while</span> (re-search-forward (format <span style="color: #259185;">"^#\\+%s:?[ \t]*</span><span style="color: #a57705;">\\</span><span style="color: #bd3612;">(</span><span style="color: #259185;">.*</span><span style="color: #a57705;">\\</span><span style="color: #bd3612;">)</span><span style="color: #259185;">"</span> property) nil t)
              (add-to-list 'values (substring-no-properties (match-string 1))))
            (<span style="color: #728a05;">if</span> all
                values
              (car values))))))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-elisp">(org-get-header-property <span style="color: #259185;">"TEST"</span>)
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-2" class="outline-3">
<h3 id="sec-2-2">Get drawer contents</h3>
<div class="outline-text-3" id="text-2-2">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #728a05;">defun</span> <span style="color: #2075c7;">org-get-drawer</span> (drawer-name)
  <span style="color: #465a61; font-style: italic;">"Get the contents of the drawer named 'drawer-name', at current section."</span>
  (<span style="color: #728a05;">save-excursion</span>
    (org-back-to-heading)
    (<span style="color: #728a05;">let*</span> ((plist (cadr (org-element-at-point)))
           (node-end (plist-get plist <span style="color: #728a05;">:end</span>))
           drawer-begin)
      (re-search-forward (format <span style="color: #259185;">"^:%s:"</span> drawer-name) node-end)
      (forward-char)
      (setq drawer-begin (point))
      (re-search-forward <span style="color: #259185;">"^:END:"</span> node-end)
      (beginning-of-line)
      (backward-char)
      (buffer-substring drawer-begin (point)))))
</pre>
</div>

<p>
test ** Set state of current heading to COMMENT
</p>



<p>
This function is derived by modifying org-toggle-comment.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #728a05;">defun</span> <span style="color: #2075c7;">org-set-comment</span> ()
  <span style="color: #465a61; font-style: italic;">"Change the COMMENT state of an entry to COMMENT.</span>
<span style="color: #465a61; font-style: italic;">Do *not* remove COMMENT state if already present.</span>
<span style="color: #465a61; font-style: italic;">This function is derived from org-toggle-coment."</span>
  (interactive)
  (<span style="color: #728a05;">save-excursion</span>
    (org-back-to-heading)
    (<span style="color: #728a05;">let</span> (case-fold-search)
      (<span style="color: #728a05;">cond</span>
       ((looking-at (format org-heading-keyword-regexp-format
                            org-comment-string))
        <span style="color: #465a61; font-style: italic;">;; </span><span style="color: #465a61; font-style: italic;">if comment was found, then do nothing:</span>
        )
       ((looking-at org-outline-regexp)
        (goto-char (match-end 0))
        (insert org-comment-string <span style="color: #259185;">" "</span>))))))

(<span style="color: #728a05;">eval-after-load</span> 'org
  '(define-key org-mode-map (kbd <span style="color: #259185;">"C-c C-;"</span>) 'org-set-comment))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-3" class="outline-3">
<h3 id="sec-2-3">Comment out the rest of a section following a comment line</h3>
<div class="outline-text-3" id="text-2-3">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #728a05;">defun</span> <span style="color: #2075c7;">org-pm-create-excerpt</span> ()
    <span style="color: #465a61; font-style: italic;">"If an org-mode-style comment with contents: READMORE is found,</span>
<span style="color: #465a61; font-style: italic;">then insert a heading after the comment, and add COMMENT status to that heading.</span>
<span style="color: #465a61; font-style: italic;">This excludes the rest of the section from being exported.</span>
<span style="color: #465a61; font-style: italic;">If no READMORE is found, then COMMENT the entire section.</span>
<span style="color: #465a61; font-style: italic;">This is an easy way of creating excerpts when copying a flle to a project,</span>
<span style="color: #465a61; font-style: italic;">and parts of this file are also copied to the project, so we don't want to</span>
<span style="color: #465a61; font-style: italic;">export them with the main file."</span>
    (interactive)
    (<span style="color: #728a05;">save-excursion</span>
      (org-back-to-heading)
      (<span style="color: #728a05;">let*</span> ((plist (cadr (org-element-at-point)))
             (node-begin (plist-get plist <span style="color: #728a05;">:begin</span>))
             (node-end (plist-get plist <span style="color: #728a05;">:end</span>)))
        (re-search-forward <span style="color: #259185;">"^ # READMORE"</span> node-end t)
        (<span style="color: #728a05;">unless</span> (equal (point) node-begin)
          (org-insert-heading)
          (org-set-comment))
        (message <span style="color: #259185;">"%d %d %d"</span> (point) node-begin node-end)
        )))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-4" class="outline-3">
<h3 id="sec-2-4"><a id="ID-6F334A92-6B8C-473B-B8C5-1BAFB70F819F" name="ID-6F334A92-6B8C-473B-B8C5-1BAFB70F819F"></a>Functions for adding, removing and replacing elements in a-lists</h3>
<div class="outline-text-3" id="text-2-4">

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #728a05;">defun</span> <span style="color: #2075c7;">assoc-add</span> (alist key element)
  <span style="color: #465a61; font-style: italic;">"Add element to the sublist of alist which starts with key."</span>
  (<span style="color: #728a05;">let</span> ((sublist (assoc key alist)))
    (<span style="color: #728a05;">if</span> sublist
        (setcdr sublist (cons element (cdr sublist)))
      (<span style="color: #728a05;">if</span> alist
          (setcdr alist (cons (list key element) (cdr alist)))
        (setq alist (list (list key element))))))
  alist)

(<span style="color: #728a05;">defun</span> <span style="color: #2075c7;">assoc-remove</span> (alist key element)
  <span style="color: #465a61; font-style: italic;">"Remove element from the sublist of alist whose car is equal to key."</span>
  (<span style="color: #728a05;">when</span> alist
    (<span style="color: #728a05;">let</span> ((sublist (assoc key alist)))
      (<span style="color: #728a05;">when</span> sublist
        (setcdr sublist(remove element (cdr sublist)))
        (<span style="color: #728a05;">if</span> (equal 1 (length sublist)) (setq alist (remove sublist alist))))
      alist)))

(<span style="color: #728a05;">defun</span> <span style="color: #2075c7;">assoc-remove-key</span> (alist key)
  <span style="color: #465a61; font-style: italic;">"Remove all sublists of alist whose car is equal to key."</span>
  (setq alist (remove* key alist <span style="color: #728a05;">:test</span> 'equal <span style="color: #728a05;">:key</span> 'car)))

  <span style="color: #465a61; font-style: italic;">;;; </span><span style="color: #465a61; font-style: italic;">older version</span>
(<span style="color: #728a05;">defun</span> <span style="color: #2075c7;">assoc-remove-key-simple-style</span> (alist key)
  <span style="color: #465a61; font-style: italic;">"Remove all sublists of alist whose car is equal to key."</span>
  (<span style="color: #728a05;">let</span> (found)
    (<span style="color: #728a05;">while</span> (setq found (assoc key alist))
      (setq alist (delq found alist)))
    alist))

(<span style="color: #728a05;">defun</span> <span style="color: #2075c7;">assoc-replace</span> (alist key newlist)
  <span style="color: #465a61; font-style: italic;">"Remove all sublists of alist whose car is equal to key, and then</span>
<span style="color: #465a61; font-style: italic;">     add (cons key newlist) to alist."</span>
  (setq alist (assoc-remove-key alist key))
  (setq alist (cons (cons key newlist) alist)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-5" class="outline-3">
<h3 id="sec-2-5"><a id="ID-29715E74-6E71-43C0-A50C-F312C3173645" name="ID-29715E74-6E71-43C0-A50C-F312C3173645"></a>org-pm-make-default-project-alist</h3>
<div class="outline-text-3" id="text-2-5">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #728a05;">defun</span> <span style="color: #2075c7;">org-pm-make-default-project-plist</span> ()
  <span style="color: #465a61; font-style: italic;">"Construct default plist for publishing a project in html."</span>
  (<span style="color: #728a05;">let</span> ((plist (copy-sequence org-pm-default-project-plist)))
    (setq plist (plist-put plist <span style="color: #728a05;">:base-directory</span>
                           (file-truename org-pm-default-project-org-folder)))
    (setq plist (plist-put plist <span style="color: #728a05;">:publishing-directory</span>
                           (file-truename org-pm-default-project-html-folder)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2-6" class="outline-3">
<h3 id="sec-2-6"><a id="ID-1FE8167C-A514-4C21-9FC2-4A466A692E56" name="ID-1FE8167C-A514-4C21-9FC2-4A466A692E56"></a>org-pm-add-project-file</h3>
<div class="outline-text-3" id="text-2-6">

<p>
When a file or a section of a file should be copied to a project base directory, add the project name to the list of projects of this file.  The list of projects of files is stored in org-pm-files.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #728a05;">defun</span> <span style="color: #2075c7;">org-pm-add-project-file</span> (project-name file)
  <span style="color: #465a61; font-style: italic;">"In list org-pm-files, add the project-name to the list</span>
<span style="color: #465a61; font-style: italic;">of projects that file bel ongs. "</span>
  (setq org-pm-files
        (assoc-add org-pm-files file project-name)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-7" class="outline-3">
<h3 id="sec-2-7"><a id="ID-1FE8167C-A514-4C21-9FC2-4A466A692E56" name="ID-1FE8167C-A514-4C21-9FC2-4A466A692E56"></a>org-pm-remove-project-file</h3>
<div class="outline-text-3" id="text-2-7">

<p>
When a file or a section of a file should be removed from a project, remove the project name from the list of projects of this file in org-pm-files.  (The list of projects of files is stored in org-pm-files.)
</p>

<p>
NOTE: Removing components from projects is more complex than adding, because we should also remove the files of the components from the base directory of the project.  Therefore: org-pm-parse-buffer must remove any files of components that no longer exist.  How to do this?
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #728a05;">defun</span> <span style="color: #2075c7;">org-pm-remove-project-file</span> (project-name file)
  <span style="color: #465a61; font-style: italic;">"In list org-pm-files, add the project-name to the list</span>
<span style="color: #465a61; font-style: italic;">of projects that file belongs. "</span>
  (setq org-pm-files
        (assoc-add org-pm-files file project-name)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-8" class="outline-3">
<h3 id="sec-2-8"><a id="ID-3E557B48-9700-4BEE-9D72-D4AC276DCF9C" name="ID-3E557B48-9700-4BEE-9D72-D4AC276DCF9C"></a>org-pm-add-project-to-file-header</h3>
<div class="outline-text-3" id="text-2-8">

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #728a05;">defun</span> <span style="color: #2075c7;">org-pm-add-project-to-file-header</span> (project-name)
  <span style="color: #465a61; font-style: italic;">"Add property PROJECT with value project-name at beginning of file."</span>
  (<span style="color: #728a05;">save-excursion</span>
    (<span style="color: #728a05;">save-restriction</span>
      (widen)
      (beginning-of-buffer)
      (insert (format <span style="color: #259185;">"#+PROJECT: %s\n"</span> project-name)))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-9" class="outline-3">
<h3 id="sec-2-9"><a id="ID-02A9DD60-795A-462D-A803-91E8D719560B" name="ID-02A9DD60-795A-462D-A803-91E8D719560B"></a>org-pm-get-section-projects</h3>
<div class="outline-text-3" id="text-2-9">

<p>
Get list of all projects to which any individual sections in the file should be copied. Such projects Projects are named by tags in sections.  The tags must be enclosed in underscores "_". For example, if a section has the tag <code>_blog_</code> it will be copied to be published in project named <code>blog</code>.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #728a05;">defun</span> <span style="color: #2075c7;">org-pm-get-section-projects</span> ()

)
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-10" class="outline-3">
<h3 id="sec-2-10">org-pm-edit-project-template</h3>
<div class="outline-text-3" id="text-2-10">
<p>
Edit the file containing the global project template.
Note that edits may cause conflicts when updating org-pm from git.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #728a05;">defun</span> <span style="color: #2075c7;">org-pm-edit-project-template</span> ()
  <span style="color: #465a61; font-style: italic;">"Edit the file containing the global project template.</span>
<span style="color: #465a61; font-style: italic;">Note that edits may cause conflicts when updating org-pm from git."</span>
  (interactive)
  (find-file org-pm-project-template-file-name))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-11" class="outline-3">
<h3 id="sec-2-11">org-pm-edit-saved-project-data</h3>
<div class="outline-text-3" id="text-2-11">
<p>
Edit the file containing the auto-saved data for org-pom.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #728a05;">defun</span> <span style="color: #2075c7;">org-pm-edit-saved-project-data</span> ()
  <span style="color: #465a61; font-style: italic;">"Edit the file containing the global project data."</span>
  (interactive)
  (find-file org-pm-project-data-file-path))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-12" class="outline-3">
<h3 id="sec-2-12">org-pm-show-project-definition-section</h3>
<div class="outline-text-3" id="text-2-12">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #728a05;">defun</span> <span style="color: #2075c7;">org-pm-show-project-definition-section</span> ()
  <span style="color: #465a61; font-style: italic;">"Mark all sections tagged PROJECT_DEFS.</span>
<span style="color: #465a61; font-style: italic;">  Additionally go to the first section tagged PROJECT_DEFS, if it exists."</span>
  (interactive)
  (<span style="color: #728a05;">let</span> ((defs (org-map-entries '(cadr (org-element-at-point)) <span style="color: #259185;">"PROJECT_DEFS"</span>)))
    (<span style="color: #728a05;">cond</span>
     (defs
       (org-match-sparse-tree nil <span style="color: #259185;">"PROJECT_DEFS"</span>)
       (goto-char (plist-get (car defs) <span style="color: #728a05;">:begin</span>))
       (recenter-top-bottom '(4))
       (message <span style="color: #259185;">"Showing location of first project definition section found."</span>))
     (t (message <span style="color: #259185;">"No project definitions were found in this file."</span>)))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-13" class="outline-3">
<h3 id="sec-2-13"><a id="ID-36439CB5-E875-4E45-B595-5116888C9DCA" name="ID-36439CB5-E875-4E45-B595-5116888C9DCA"></a>org-pm-make-project-template</h3>
<div class="outline-text-3" id="text-2-13">

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #728a05;">defun</span> <span style="color: #2075c7;">org-pm-make-project-template</span> (<span style="color: #a57705;">&amp;optional</span> project-name no-name-query no-query)
  <span style="color: #465a61; font-style: italic;">"Create a project definition template and insert it into current file.</span>
<span style="color: #465a61; font-style: italic;">Input project name, base directory and publishing directory from user.</span>
<span style="color: #465a61; font-style: italic;">Skip input step if called with prefix argument.</span>
<span style="color: #465a61; font-style: italic;">Read file containing template of project definition</span>
<span style="color: #465a61; font-style: italic;">from org-pm-project-template-file-name</span>
<span style="color: #465a61; font-style: italic;">If arguments present, replace relevant parts of the template with</span>
<span style="color: #465a61; font-style: italic;">custom name, base-directory, publishing-directory</span>
<span style="color: #465a61; font-style: italic;">Insert the resulting template in the current file.</span>
<span style="color: #465a61; font-style: italic;">Create the project as well as its static project and component project.</span>
<span style="color: #465a61; font-style: italic;">Store all 3 in org-publish-project-alists.</span>
<span style="color: #465a61; font-style: italic;">Save updated project, file and duplicate lists to disk."</span>
  (interactive <span style="color: #259185;">"P"</span>)
  (<span style="color: #728a05;">let*</span> ((base-directory (file-truename <span style="color: #259185;">"~/org-pm/"</span>))
         (publishing-directory
          (file-truename <span style="color: #259185;">"~/Sites/org-pm/"</span>))
         (def-node
           (car (org-map-entries '(cadr (org-element-at-point)) <span style="color: #259185;">"PROJECT_DEFS"</span>)))
         (buffer (get-buffer-create <span style="color: #259185;">"*def*"</span>))
         plist template-string)
    (<span style="color: #728a05;">unless</span> project-name (setq project-name <span style="color: #259185;">"org-pm-default"</span>))
    (<span style="color: #728a05;">unless</span> no-name-query
      (setq project-name (read-string <span style="color: #259185;">"Enter project name: "</span> project-name)))
    (<span style="color: #728a05;">unless</span> no-query
      (setq base-directory (query-make-folder base-directory))
      (setq publishing-directory (query-make-folder publishing-directory)))
    (<span style="color: #728a05;">save-excursion</span>
      (set-buffer buffer)
      (insert-file-contents org-pm-project-template-file-name)
      (beginning-of-buffer)
      (replace-string <span style="color: #259185;">"PROJECTNAME"</span> project-name)
      (beginning-of-buffer)
      (replace-string <span style="color: #259185;">"BASEDIRECTORY"</span> base-directory)
      (beginning-of-buffer)
      (replace-string <span style="color: #259185;">"PUBLISHINGDIRECTORY"</span> publishing-directory)
      (setq template-string (buffer-string))
      (kill-buffer buffer))
    (<span style="color: #728a05;">cond</span> (def-node
           (goto-char (plist-get def-node <span style="color: #728a05;">:begin</span>))
           (end-of-line)
           (insert <span style="color: #259185;">"\n"</span>)
           (org-paste-subtree (+ 1 (plist-get def-node <span style="color: #728a05;">:level</span>)) template-string))
          (t
           (end-of-buffer)
           (insert <span style="color: #259185;">"\n* COMMENT Project Definitions              :PROJECT_DEFS:\n"</span>)
           (org-paste-subtree 2 template-string)))
    (org-id-get-create)
    (org-pm-check-add-project (org-pm-parse-project-def (cadr (org-element-at-point))))
    (org-pm-save-all-project-data)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-14" class="outline-3">
<h3 id="sec-2-14">Providing relative paths to root of published project</h3>
<div class="outline-text-3" id="text-2-14">
<p>
This makes sure that when a file is copied to a subfolder of the publishing directory, the paths pointing to includes such as css, images, etc. will be converted to show to the root of the project, so that links work.  Such links must be marked using the string <code>.</code> to denote the relative root to the published project, that is, the <code>publishing-directory</code>.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #728a05;">defun</span> <span style="color: #2075c7;">org-html-provide-relative-path</span> (string backend info)
  <span style="color: #465a61; font-style: italic;">"Provide relative path for link."</span>
  (<span style="color: #728a05;">when</span> (org-export-derived-backend-p backend 'html)
    (replace-regexp-in-string
     <span style="color: #259185;">"."</span>
     (org-make-relpath-string
      (plist-get info <span style="color: #728a05;">:publishing-directory</span>)
      (plist-get info '<span style="color: #728a05;">:input-file</span>))
     string)))

<span style="color: #465a61; font-style: italic;">;;; </span><span style="color: #465a61; font-style: italic;">Add relative path filter to export final output functions</span>
(add-to-list 'org-export-filter-final-output-functions
             'org-html-provide-relative-path)

(<span style="color: #728a05;">defun</span> <span style="color: #2075c7;">org-make-relpath-string</span> (base-path file-path)
  <span style="color: #465a61; font-style: italic;">"create a relative path for reaching base-path from file-path ('./../..' etc)"</span>
  (<span style="color: #728a05;">let</span> (
        (path <span style="color: #259185;">"."</span>)
        (depth (-
                (length (split-string (file-name-directory file-path) <span style="color: #259185;">"/"</span>))
                (length (split-string base-path <span style="color: #259185;">"/"</span>)))))
    (<span style="color: #728a05;">dotimes</span> (number
              (- depth 1)
              path)
      (setq path (concat path <span style="color: #259185;">"/.."</span>)))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-15" class="outline-3">
<h3 id="sec-2-15">Customizing the heading of table of contents</h3>
<div class="outline-text-3" id="text-2-15">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #728a05;">defun</span> <span style="color: #2075c7;">org-html-toc</span> (depth info)
  <span style="color: #465a61; font-style: italic;">"Build a table of contents.</span>
<span style="color: #465a61; font-style: italic;">DEPTH is an integer specifying the depth of the table.  INFO is a</span>
<span style="color: #465a61; font-style: italic;">plist used as a communication channel.  Return the table of</span>
<span style="color: #465a61; font-style: italic;">contents as a string, or nil if it is empty."</span>
  (<span style="color: #728a05;">let</span> ((toc-heading (plist-get info <span style="color: #728a05;">:toc-heading</span>))
        (toc-entries
         (mapcar (<span style="color: #728a05;">lambda</span> (headline)
                   (cons (org-html--format-toc-headline headline info)
                         (org-export-get-relative-level headline info)))
                 (org-export-collect-headlines info depth)))
        (outer-tag (<span style="color: #728a05;">if</span> (and (org-html-html5-p info)
                            (plist-get info <span style="color: #728a05;">:html-html5-fancy</span>))
                       <span style="color: #259185;">"nav"</span>
                     <span style="color: #259185;">"div"</span>)))
    (<span style="color: #728a05;">when</span> toc-entries
      (<span style="color: #728a05;">unless</span> toc-heading (setq toc-heading <span style="color: #259185;">"Table of Contents"</span>))
      (concat (format <span style="color: #259185;">"&lt;%s id=\"table-of-contents\"&gt;\n"</span> outer-tag)
              (format <span style="color: #259185;">"&lt;h%d&gt;%s&lt;/h%d&gt;\n"</span>
                      org-html-toplevel-hlevel
                      (org-html--translate toc-heading info)
                      org-html-toplevel-hlevel)
              <span style="color: #259185;">"&lt;div id=\"text-table-of-contents\"&gt;"</span>
              (org-html--toc-text toc-entries)
              <span style="color: #259185;">"&lt;/div&gt;\n"</span>
              (format <span style="color: #259185;">"&lt;/%s&gt;\n"</span> outer-tag)))))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">Setup auto-parse and auto-copy</h2>
<div class="outline-text-2" id="text-3">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(add-hook 'after-save-hook 'org-pm-maybe-parse-and-copy)

(<span style="color: #728a05;">defun</span> <span style="color: #2075c7;">org-pm-maybe-parse-and-copy</span> ()
  <span style="color: #465a61; font-style: italic;">"This function is run whenever a file is saved.</span>
<span style="color: #465a61; font-style: italic;">If org-pm-auto-parse is true, make projects whose definitions are in this buffer.</span>
<span style="color: #465a61; font-style: italic;">If org-pm-auto-copy is set to 'on-save, then copy the file and sections</span>
<span style="color: #465a61; font-style: italic;">specified to their project base directory folders."</span>
  (<span style="color: #728a05;">when</span> (equal major-mode 'org-mode)
    (<span style="color: #728a05;">if</span> org-pm-auto-parse
        <span style="color: #465a61; font-style: italic;">;; </span><span style="color: #465a61; font-style: italic;">if org-pm-auto-copy is not nil, then don't save here:</span>
        (org-pm-make-projects org-pm-auto-copy))
    (<span style="color: #728a05;">if</span> (equal org-pm-auto-copy 'on-save)
        <span style="color: #465a61; font-style: italic;">;; </span><span style="color: #465a61; font-style: italic;">Always save if running this.</span>
        (org-pm-copy-components-to-projects))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">Main functions and commands</h2>
<div class="outline-text-2" id="text-4">
</div>

<div id="outline-container-sec-4-1" class="outline-3">
<h3 id="sec-4-1">org-pm-do-auto / org-pm-dont-auto</h3>
<div class="outline-text-3" id="text-4-1">
<p>
Utility functions
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #728a05;">defun</span> <span style="color: #2075c7;">org-pm-do-auto</span> ()
  (interactive)
  (setq org-pm-auto-parse t)
  (setq org-pm-auto-copy 'on-save))

(<span style="color: #728a05;">defun</span> <span style="color: #2075c7;">org-pm-dont-auto</span> ()
  (interactive)
  (setq org-pm-auto-parse nil)
  (setq org-pm-auto-copy nil))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4-2" class="outline-3">
<h3 id="sec-4-2">org-pm-load-all-project-data</h3>
<div class="outline-text-3" id="text-4-2">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #728a05;">defun</span> <span style="color: #2075c7;">org-pm-load-all-project-data</span> ()
  <span style="color: #465a61; font-style: italic;">"Load project alist, project file lists, duplicate project def lists</span>
<span style="color: #465a61; font-style: italic;">from previously saved date on disk."</span>
  (interactive)
  (<span style="color: #728a05;">if</span> (file-exists-p org-pm-project-data-file-path)
      (load-file org-pm-project-data-file-path)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4-3" class="outline-3">
<h3 id="sec-4-3">org-pm-save-all-project-data</h3>
<div class="outline-text-3" id="text-4-3">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #728a05;">defun</span> <span style="color: #2075c7;">org-pm-save-all-project-data</span> ()
  <span style="color: #465a61; font-style: italic;">"Load project alist, project file lists, duplicate project def lists</span>
<span style="color: #465a61; font-style: italic;">from previously saved date on disk."</span>
  (interactive)
  (dump-vars-to-file
   '(org-publish-project-alist org-pm-files org-pm-project-def-duplicates)
   org-pm-project-data-file-path))

(<span style="color: #728a05;">defun</span> <span style="color: #2075c7;">dump-vars-to-file</span> (varlist filename)
  <span style="color: #465a61; font-style: italic;">"simplistic dumping of variables in VARLIST to a file FILENAME"</span>
  (<span style="color: #728a05;">save-excursion</span>
    (<span style="color: #728a05;">let</span> ((buf (find-file-noselect filename)))
      (set-buffer buf)
      (erase-buffer)
      (dump varlist buf)
      (save-buffer)
      (kill-buffer))))

(<span style="color: #728a05;">defun</span> <span style="color: #2075c7;">dump</span> (varlist buffer)
  <span style="color: #465a61; font-style: italic;">"insert into buffer the setq statement to recreate the variables in VARLIST"</span>
  (<span style="color: #728a05;">loop</span> for var in varlist do
        (print (list 'setq var (list 'quote (symbol-value var)))
               buffer)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4-4" class="outline-3">
<h3 id="sec-4-4">org-pm-reset-project-list</h3>
<div class="outline-text-3" id="text-4-4">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #728a05;">defun</span> <span style="color: #2075c7;">org-pm-reset-project-list</span> ()
  <span style="color: #465a61; font-style: italic;">"Set org-publish-project-alist to nil.  Save"</span>
  (interactive)
  (<span style="color: #728a05;">cond</span> ((y-or-n-p <span style="color: #259185;">"Really erase all projects and save?"</span>)
         (setq org-publish-project-alist)
         (org-pm-save-all-project-data))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4-5" class="outline-3">
<h3 id="sec-4-5">org-pm-make-projects</h3>
<div class="outline-text-3" id="text-4-5">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #728a05;">defun</span> <span style="color: #2075c7;">org-pm-make-projects</span> (<span style="color: #a57705;">&amp;optional</span> do-not-save-now)
  <span style="color: #465a61; font-style: italic;">"Construct the projects for all project definitions found in current file.</span>
<span style="color: #465a61; font-style: italic;">Project definitions are those nodes which are contained in nodes tagged as</span>
<span style="color: #465a61; font-style: italic;">PROJECT_DEFS.</span>
<span style="color: #465a61; font-style: italic;">Note about project definition node-IDs:</span>
<span style="color: #465a61; font-style: italic;">Section IDs of project definitions are used only as links</span>
<span style="color: #465a61; font-style: italic;">to point to the position in the file where a project definition is, located.</span>
<span style="color: #465a61; font-style: italic;">They do nod identify a project.  A project is identified by its name.</span>
<span style="color: #465a61; font-style: italic;">Therefore:</span>
<span style="color: #465a61; font-style: italic;">The node-id of a project is set to &lt;full-file-path&gt;::#&lt;section id&gt;.</span>
<span style="color: #465a61; font-style: italic;">When a duplicate section id is found in a definition, it is replaced by a new one,</span>
<span style="color: #465a61; font-style: italic;">and the new id is stored in the project."</span>
  (interactive)
  (<span style="color: #728a05;">unless</span> org-publish-project-alist (org-pm-load-all-project-data))
  (<span style="color: #728a05;">let</span> ((template (org-pm-make-default-project-plist))
        levels id ids projects)
    (org-map-entries
     '(<span style="color: #728a05;">let</span>
          ((entry (cadr (org-element-at-point))))
        (<span style="color: #728a05;">if</span> (member <span style="color: #259185;">"PROJECT_DEFS"</span> (plist-get entry <span style="color: #728a05;">:tags</span>))
            (setq levels (cons (+ 1 (plist-get entry <span style="color: #728a05;">:level</span>)) levels)))
        (<span style="color: #728a05;">when</span> (equal (car levels) (plist-get entry <span style="color: #728a05;">:level</span>))
          (setq id (org-id-get-create))
          (<span style="color: #728a05;">when</span> (member id ids)
            (org-delete-property <span style="color: #259185;">"ID"</span>)
            (setq id (org-id-get-create))
            (setq entry (plist-put entry <span style="color: #728a05;">:ID</span> id)))
          (setq ids (cons id ids))
          (setq projects (cons (org-pm-parse-project-def entry template) projects))))
     <span style="color: #259185;">"PROJECT_DEFS"</span>)
    (mapcar 'org-pm-check-add-project projects)
    (<span style="color: #728a05;">unless</span> do-not-save-now (org-pm-save-all-project-data))
    (message <span style="color: #259185;">"Org-pm defined %d projects"</span> (length projects))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4-6" class="outline-3">
<h3 id="sec-4-6">org-pm-parse-project-def</h3>
<div class="outline-text-3" id="text-4-6">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #728a05;">defun</span> <span style="color: #2075c7;">org-pm-parse-project-def</span> (proj-node <span style="color: #a57705;">&amp;optional</span> template)
  <span style="color: #465a61; font-style: italic;">"Create a project definition list based on the contents of the</span>
<span style="color: #465a61; font-style: italic;">section described in proj-node plist. Convert headings</span>
<span style="color: #465a61; font-style: italic;">to property names and contents to their values.</span>
<span style="color: #465a61; font-style: italic;">Add useful identification data.</span>
<span style="color: #465a61; font-style: italic;">Argument template is a plist with additional properties,</span>
<span style="color: #465a61; font-style: italic;">but may be left out if the section contains all the properties needed</span>
<span style="color: #465a61; font-style: italic;">to define the project."</span>
  (<span style="color: #728a05;">unless</span> org-publish-project-alist (org-pm-load-all-project-data))
  (<span style="color: #728a05;">let</span> ((pdef (copy-sequence template))
        (pname (plist-get proj-node <span style="color: #728a05;">:raw-value</span>))
        (begin (plist-get proj-node <span style="color: #728a05;">:contents-begin</span>))
        (node-id (plist-get proj-node <span style="color: #728a05;">:ID</span>))
        (file-name (buffer-file-name (current-buffer))))
    (setq pdef (plist-put pdef <span style="color: #728a05;">:project-name</span> pname))
    (setq pdef (plist-put pdef <span style="color: #728a05;">:node-id</span> node-id))
    (setq pdef (plist-put pdef <span style="color: #728a05;">:node-filename</span> file-name))
    (setq pdef (plist-put pdef <span style="color: #728a05;">:project-id</span> (concat file-name <span style="color: #259185;">"::#"</span> node-id)))
    (setq pdef (plist-put pdef <span style="color: #728a05;">:last-updated</span> (format-time-string <span style="color: #259185;">"[%Y-%m-%d %a %H:%M]"</span>))<span style="color: #706f6f; background-color: #042028;">)</span>
    (<span style="color: #728a05;">cond</span>
     (begin
      (<span style="color: #728a05;">save-excursion</span>
        (<span style="color: #728a05;">save-restriction</span>
          (narrow-to-region begin (plist-get proj-node <span style="color: #728a05;">:contents-end</span>))
          (org-map-entries
           '(<span style="color: #728a05;">let*</span> (
                   (element (cadr (org-element-at-point)))
                   (heading (plist-get element <span style="color: #728a05;">:raw-value</span>))
                   (space (string-match <span style="color: #259185;">" .*"</span> heading))
                   prop-name prop-value contents-begin)
              (<span style="color: #728a05;">cond</span>
               (space
                (setq prop-name (substring heading 0 space))
                (setq prop-value (eval (read (substring heading space))))
                (<span style="color: #728a05;">if</span> (and
                     (equal prop-name <span style="color: #259185;">"include-containing-file"</span>)
                     prop-value)
                    (org-pm-add-component
                     pname (buffer-file-name (current-buffer)) prop-value)))
               (t (setq prop-name heading)
                  (setq contents-begin (plist-get element <span style="color: #728a05;">:contents-begin</span>))
                  (<span style="color: #728a05;">if</span> contents-begin
                      (setq
                       prop-value
                       (buffer-substring-no-properties
                        contents-begin
                        (plist-get element <span style="color: #728a05;">:contents-end</span>))))))
              (setq pdef
                    (plist-put pdef (intern (concat <span style="color: #259185;">":"</span> prop-name)) prop-value))))))))
    (cons pname pdef)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4-7" class="outline-3">
<h3 id="sec-4-7">org-pm-check-add-project</h3>
<div class="outline-text-3" id="text-4-7">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #728a05;">require</span> '<span style="color: #259185;">dash</span>)
(<span style="color: #728a05;">defun</span> <span style="color: #2075c7;">org-pm-check-add-project</span> (project)
  <span style="color: #465a61; font-style: italic;">"Add the project definition contained in plist 'project' to org-publish-project-alist,</span>
<span style="color: #465a61; font-style: italic;">replacing any previously existing definition there.  Before replacing, save any</span>
<span style="color: #465a61; font-style: italic;">previously existing project whose definition is in a different file component in</span>
<span style="color: #465a61; font-style: italic;">the variable org-pm-project-def-duplicates:</span>
<span style="color: #465a61; font-style: italic;">If a project with the same name already exists in org-publish-project-alist,</span>
<span style="color: #465a61; font-style: italic;">and that project has a different ID (file path + section ID), then the previously</span>
<span style="color: #465a61; font-style: italic;">existing project definition is added to the list in org-pm-project-def-duplicates.</span>
<span style="color: #465a61; font-style: italic;">Also create static and combined project components.</span>
<span style="color: #465a61; font-style: italic;">Create alternate ids for the latter, by appending -static and -combined</span>
<span style="color: #465a61; font-style: italic;">to the id of the main project."</span>
  (<span style="color: #728a05;">unless</span> org-publish-project-alist (org-pm-load-all-project-data))
  (<span style="color: #728a05;">let*</span> ((p-name (car project))
         (p-def (cdr project))
         (prev-proj (assoc p-name org-publish-project-alist))
         (prev-proj-id (plist-get (cdr prev-proj) <span style="color: #728a05;">:project-id</span>))
         (duplicates (assoc p-name org-pm-project-def-duplicates))
         static-project static-project-name combined-project)
    (<span style="color: #728a05;">cond</span>
     ((not prev-proj))
     ((equal prev-proj-id (plist-get p-def <span style="color: #728a05;">:project-id</span>)))
     (t (setq
         org-pm-project-def-duplicates
         (assoc-replace org-pm-project-def-duplicates p-name
                        (add-to-list 'duplicates prev-proj-id)))))
    (setq org-publish-project-alist
          (assoc-replace org-publish-project-alist p-name p-def))
    (setq static-project
          (-flatten
           (-map
            (<span style="color: #728a05;">lambda</span> (pair)
              (list (intern (replace-regexp-in-string <span style="color: #259185;">"^:static_"</span> <span style="color: #259185;">":"</span>
                                                      (symbol-name (car pair))))
                    (cadr pair)))
                     (-filter
                      (<span style="color: #728a05;">lambda</span> (pair) (string-match <span style="color: #259185;">"^:static_"</span>
                                                   (symbol-name (car pair))))
                      (-partition 2 p-def)))))
    (setq static-project-name (concat <span style="color: #259185;">"static_"</span> p-name))
    (setq org-publish-project-alist
          (assoc-replace org-publish-project-alist
                         static-project-name static-project))
    (setq org-publish-project-alist
          (assoc-replace org-publish-project-alist
                         (concat <span style="color: #259185;">"combined-"</span> p-name)
                         (list <span style="color: #728a05;">:components</span>
                               p-name static-project-name))))
  project)
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4-8" class="outline-3">
<h3 id="sec-4-8"><a id="ID-24187886-5ADA-4263-806B-8655A9813C8B" name="ID-24187886-5ADA-4263-806B-8655A9813C8B"></a>org-pm-add-file-to-project:</h3>
<div class="outline-text-3" id="text-4-8">

<p>
Add file to current buffer to project interactively selected or input by user.
</p>

<p>
If project name input by user does not correspond to an existing project, offer to create that project.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #728a05;">defun</span> <span style="color: #2075c7;">org-pm-add-file-to-project</span> ()
  <span style="color: #465a61; font-style: italic;">"Add the file of the current buffer to a project selected or input by the user.</span>
<span style="color: #465a61; font-style: italic;">    If the project selected/input by the user is not already in the file's project list:</span>
<span style="color: #465a61; font-style: italic;">    - If no project of that name exists, request that the project be defined using</span>
<span style="color: #465a61; font-style: italic;">    org-pm or other methods.</span>
<span style="color: #465a61; font-style: italic;">    - If no project at all exists, then offer to create default project.</span>
<span style="color: #465a61; font-style: italic;">    - Add the selected project to the file's list in org-pm-files.</span>
<span style="color: #465a61; font-style: italic;">    - Save org-pm-files.</span>
<span style="color: #465a61; font-style: italic;">    - Add the project name to property PROJECT in file's header."</span>
  (interactive)
  (<span style="color: #728a05;">unless</span> (buffer-file-name (current-buffer))
    (<span style="color: #c60007; font-weight: bold;">error</span> <span style="color: #259185;">"This buffer is not associated with a file.  Please save first."</span>))
  (<span style="color: #728a05;">let*</span> ((org-completion-use-ido t)
         (projects
          (<span style="color: #728a05;">if</span> org-publish-project-alist
              (mapcar org-publish-project-alist 'car)
            (list org-pm-default-project-name)))
         (project-name
          (org-icompleting-read <span style="color: #259185;">"Choose or input a project name: "</span> projects)))
    (<span style="color: #728a05;">if</span> (member project-name (org-pm-get-file-projects))
        (<span style="color: #c60007; font-weight: bold;">error</span> <span style="color: #259185;">"This file is already part of project '%s'"</span> project-name))
    (setq project (org-pm-query-make-default-project project-name))
    (org-pm-add-project-to-file-header project-name)
    (org-pm-add-project-file project-name (buffer-file-name (current-buffer)))
    (org-pm-save-all-project-data)
    (org-pm-make-project-template project)
    (message
     <span style="color: #259185;">"Added project named: %s to file: %s\nBase directory is: %s\nPublishing directory i</span><span style="color: #706f6f; background-color: #042028;">s: %s"</span>
     project-name
     (file-name-nondirectory (buffer-file-name (current-buffer)))
     (plist-get (cdr project) <span style="color: #728a05;">:base-directory</span>)
     (plist-get (cdr project) <span style="color: #728a05;">:publishing-directory</span>))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-9" class="outline-3">
<h3 id="sec-4-9">query-make-folder</h3>
<div class="outline-text-3" id="text-4-9">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #728a05;">defun</span> <span style="color: #2075c7;">query-make-folder</span> (path <span style="color: #a57705;">&amp;optional</span> prompt-string)
  <span style="color: #465a61; font-style: italic;">"If folder at path does not exist, then show dialog offering to user</span>
<span style="color: #465a61; font-style: italic;">    the option to create the indicated folder or to choose another path.</span>
<span style="color: #465a61; font-style: italic;">    If the path selected does not exist, create folder."</span>
  (setq path (file-truename path))
  (<span style="color: #728a05;">unless</span> prompt-string (setq prompt-string <span style="color: #259185;">"Folder select or create:"</span>))
  (<span style="color: #728a05;">let</span> ((answer
         (read-file-name
          (format
           <span style="color: #259185;">"%s\nSelect or input folder (folder will be created if needed):\n"</span>
           prompt-string)
          path)))
    (<span style="color: #728a05;">unless</span> (equal (file-truename answer) (buffer-file-name (current-buffer)))
      (setq path answer))
    (<span style="color: #728a05;">unless</span> (file-exists-p path) (make-directory path))
    path))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4-10" class="outline-3">
<h3 id="sec-4-10">org-pm-remove-file-from-project:</h3>
<div class="outline-text-3" id="text-4-10">
<p>
Remove file from project interactively selected by user.
</p>
</div>
</div>
<div id="outline-container-sec-4-11" class="outline-3">
<h3 id="sec-4-11">org-pm-add-component-to-project</h3>
<div class="outline-text-3" id="text-4-11">
<p>
Add current section (node) to a project interactively selected or input by user.
</p>

<p>
If project name input by user does not correspond to an existing project, offer to create that project.
</p>
</div>
</div>
<div id="outline-container-sec-4-12" class="outline-3">
<h3 id="sec-4-12">org-pm-remove-component-from-project</h3>
<div class="outline-text-3" id="text-4-12">
<p>
Remove current section (node) from a project interactively selected by user.
</p>
</div>
</div>
<div id="outline-container-sec-4-13" class="outline-3">
<h3 id="sec-4-13">org-pm-copy-components-to-projects</h3>
<div class="outline-text-3" id="text-4-13">
<ul class="org-ul">
<li>org-pm-copy-components can be called explicitly by the user as a command.
</li>
<li>If org-pm-auto-copy is enabled, then it is called automatically.
</li>
<li>There are two ways to automate the copying:
<ol class="org-ol">
<li>Copy whenever the file is saved.
</li>
<li>Copy whenever the project is published.
</li>
</ol>
</li>
</ul>

<p>
Assessment:
</p>

<p>
Version 1 lengthens the file saving time.
Version 1 lengthens the publishing time.
</p>

<p>
The accumulated delay of copying project components from all files when publishing may be more distracting than the delay of copying components of a single project.  Additionally, it is better to be able to check the condition of a project at any stage, and to have it updated as soon as a file is saved.  So I start by setting the default to copy components when the file is saved.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp"><span style="color: #465a61; font-style: italic;">;; </span><span style="color: #465a61; font-style: italic;">Will replace org-pm-register-project-components.</span>
(<span style="color: #728a05;">defvar</span> <span style="color: #2075c7;">*org-pm-missing-projects*</span> nil
<span style="color: #465a61; font-style: italic;">"Names of projects referenced in a file, whose definition is not found.</span>
<span style="color: #465a61; font-style: italic;">For reporting."</span>)

(<span style="color: #728a05;">defvar</span> <span style="color: #2075c7;">*org-pm-updated-projects*</span> nil
  <span style="color: #465a61; font-style: italic;">"Names of projects to which components in a file were copied.</span>
<span style="color: #465a61; font-style: italic;">For reporting"</span>)

(<span style="color: #728a05;">defvar</span> <span style="color: #2075c7;">org-pm-report-after-copying-p</span> t
<span style="color: #465a61; font-style: italic;">"If not-nil, org-pm-copy-components-to-projects will post a report</span>
<span style="color: #465a61; font-style: italic;">of projects not found or of projects targeted when finishing."</span>)

(<span style="color: #728a05;">defun</span> <span style="color: #2075c7;">org-pm-copy-components-to-projects</span> (<span style="color: #a57705;">&amp;optional</span> do-not-save-now)
  <span style="color: #465a61; font-style: italic;">"Find which parts of the file go to which to projects, and copy them</span>
<span style="color: #465a61; font-style: italic;">to the base-directories of these projects.  Also save the projects found in</span>
<span style="color: #465a61; font-style: italic;">list org-pm-files for this project, using the full path of this file as key.</span>
<span style="color: #465a61; font-style: italic;">This list is saved and can be used later to update the contents of any project</span>
<span style="color: #465a61; font-style: italic;">by finding all the files that contribute to this project.</span>

<span style="color: #465a61; font-style: italic;">Parse current buffer, looking for projects added for the whole file (with property</span>
<span style="color: #465a61; font-style: italic;">=#+PROJECT:= or for sections (with tags enclosed in =_=). Collect names of all projects</span>
<span style="color: #465a61; font-style: italic;">found in a list. Put the list in the assoc list stored in =org-pm-files=, using the full</span>
<span style="color: #465a61; font-style: italic;">path of the file as key. Function =org-pm-copy-to-project= scans this list to find if</span>
<span style="color: #465a61; font-style: italic;">the file contains any components that should be copied to the project, and copies them.</span>

<span style="color: #465a61; font-style: italic;">components: List of file and/or ids of any sections that are copied to projects.</span>
<span style="color: #465a61; font-style: italic;">              Each element is of the form:</span>
<span style="color: #465a61; font-style: italic;">              (component (project folder file) (project folder file)...)</span>
<span style="color: #465a61; font-style: italic;">Components is added to org-pm-files and auto-saved."</span>

  (interactive)
  (<span style="color: #728a05;">let*</span> ((fullpath (buffer-file-name (current-buffer)))
        (filename (file-name-nondirectory fullpath))
        components file-components (origin-buffer (current-buffer)))
    (setq file-components
          (-map (<span style="color: #728a05;">lambda</span> (component) (org-pm-parse-component component filename))
                (org-get-header-property <span style="color: #259185;">"PROJECT"</span> t)))
    (org-map-entries
     '(<span style="color: #728a05;">let*</span> (name
             (node (cadr (org-element-at-point)))
             (pspecs (-filter (<span style="color: #728a05;">lambda</span> (tag) (string-match <span style="color: #259185;">"^_.*_$"</span> tag))
                              (plist-get node <span style="color: #728a05;">:tags</span>))))
        (<span style="color: #728a05;">when</span> pspecs
          (setq name (plist-get node <span style="color: #728a05;">:raw-value</span>))
          (setq components
                (cons
                 (cons
                  (plist-get node <span style="color: #728a05;">:begin</span>)
                  (-map
                   (<span style="color: #728a05;">lambda</span> (component) (org-pm-parse-component component name))
                   pspecs))
                 components)))))
    (<span style="color: #728a05;">if</span> file-components
        (setq components (cons (cons <span style="color: #259185;">"FILE"</span> file-components) components)))
    (setq org-pm-files (assoc-replace org-pm-files fullpath components))
    <span style="color: #465a61; font-style: italic;">;; </span><span style="color: #465a61; font-style: italic;">first save, then do the copying:</span>
    (<span style="color: #728a05;">unless</span> do-not-save-now (org-pm-save-all-project-data))
    (setq *org-pm-missing-projects* nil)
    (setq *org-pm-updated-projects* nil)
    (<span style="color: #728a05;">dolist</span> (comp components)
      (<span style="color: #728a05;">let</span> ((pos (car comp))
            (target-buffer (get-buffer-create <span style="color: #259185;">"*org-pm-copy-buf*"</span>)))

        (<span style="color: #728a05;">cond</span> ((equal <span style="color: #259185;">"FILE"</span> pos)
               (set-buffer target-buffer)
               (insert-buffer origin-buffer)
               (<span style="color: #728a05;">dolist</span> (proj (cdr comp)) (org-pm-save-buffer proj target-buffer)))
             (t
              (set-buffer origin-buffer)
              (goto-char pos)
              (org-copy-subtree)
              (set-buffer target-buffer)
              (org-paste-subtree 1)
              (<span style="color: #728a05;">dolist</span> (proj (cdr comp)) (org-pm-save-buffer proj target-buffer))))
       (kill-buffer target-buffer)))
    (<span style="color: #728a05;">if</span> org-pm-report-after-copying-p
        (<span style="color: #728a05;">if</span> *org-pm-missing-projects*
         (grizzl-completing-read <span style="color: #259185;">"These projects could not be found"</span>
                                 (grizzl-make-index *org-pm-missing-projects*))
       (grizzl-completing-read <span style="color: #259185;">"Copied components to these projects"</span>
                               (grizzl-make-index *org-pm-updated-projects*))))
    (message <span style="color: #259185;">"Result: %s"</span> components)))

(<span style="color: #728a05;">defun</span> <span style="color: #2075c7;">org-pm-parse-component</span> (component filename)
  (<span style="color: #728a05;">let</span> ((parts
         (-take 3 (split-string
                   (concat (replace-regexp-in-string <span style="color: #259185;">"#"</span> <span style="color: #259185;">"."</span> component) <span style="color: #259185;">"@@"</span>) <span style="color: #259185;">"@"</span>))))
    (setq parts
          (cons (replace-regexp-in-string
                 <span style="color: #259185;">"^_"</span> <span style="color: #259185;">""</span> (replace-regexp-in-string <span style="color: #259185;">"_$"</span> <span style="color: #259185;">""</span> (car parts)))
                (cdr parts)))
    (<span style="color: #728a05;">unless</span> (equal 0 (length (caddr parts)))
        (setq filename (caddr parts)))
    (setq filename (replace-regexp-in-string <span style="color: #259185;">" "</span> <span style="color: #259185;">"-"</span> filename))
    (<span style="color: #728a05;">unless</span> (string-match <span style="color: #259185;">".org$"</span> filename)
      (setq filename (concat filename <span style="color: #259185;">".org"</span>)))
    (setq parts (-replace-at 2 filename parts))
    parts))


(<span style="color: #728a05;">defun</span> <span style="color: #2075c7;">org-pm-save-buffer</span> (specs buffer)
  (<span style="color: #728a05;">let</span> ((target-path (org-pm-make-target specs)))
    (make-directory (file-name-directory target-path) t)
    (write-region nil nil target-path)
    ))

<span style="color: #465a61; font-style: italic;">;; </span><span style="color: #465a61; font-style: italic;">superseded by org-pm-save-buffer:</span>
(<span style="color: #728a05;">defun</span> <span style="color: #2075c7;">org-pm-copy-file</span> (specs <span style="color: #a57705;">&amp;optional</span> path-of-file-to-copy-from)
  <span style="color: #465a61; font-style: italic;">"Dopy the contents of file specified in path-of-filet-copy-from</span>
<span style="color: #465a61; font-style: italic;">to the target location given by specs.</span>
<span style="color: #465a61; font-style: italic;">If path-of-file-to-copy-from is nil, then copy the contents of the current</span>
<span style="color: #465a61; font-style: italic;">buffer.</span>
<span style="color: #465a61; font-style: italic;">NOTE: path-of-file-to-copy-from : NOT YET IMPLEMENTED."</span>
  (<span style="color: #728a05;">let</span> ((origin-buffer (current-buffer))
        (target-buffer (get-buffer-create <span style="color: #259185;">"*org-pm-copy-buf*"</span>))
        (target-path (org-pm-make-target specs)))
    (set-buffer target-buffer)
    (insert-buffer origin-buffer)
    <span style="color: #465a61; font-style: italic;">;; </span><span style="color: #465a61; font-style: italic;">Shall we switch-on COMMENT for all exported sections here?</span>
    <span style="color: #465a61; font-style: italic;">;; </span><span style="color: #465a61; font-style: italic;">Do READMORE conversion?</span>
    <span style="color: #465a61; font-style: italic;">;; </span><span style="color: #465a61; font-style: italic;">(message "org-pm-copy-file copying to this path:\n %s" target-path)</span>
    (make-directory (file-name-directory target-path) t)
    (write-region nil nil target-path)
    (kill-buffer target-buffer)))

<span style="color: #465a61; font-style: italic;">;; </span><span style="color: #465a61; font-style: italic;">superseded by org-pm-save-buffer:</span>
(<span style="color: #728a05;">defun</span> <span style="color: #2075c7;">org-pm-copy-section</span> (specs)
  (org-pm-make-target specs))

(<span style="color: #728a05;">defun</span> <span style="color: #2075c7;">org-pm-make-target</span> (specs)
  (<span style="color: #728a05;">let*</span> ((project-name (car specs))
         (folder (cadr specs))
         (slash (<span style="color: #728a05;">if</span> (string-match <span style="color: #259185;">"/$"</span> folder) <span style="color: #259185;">""</span> <span style="color: #259185;">"/"</span>))
         (project (assoc project-name org-publish-project-alist)))
    (<span style="color: #728a05;">cond</span> (project
           (add-to-list '*org-pm-updated-projects* project-name)
           (concat (plist-get (cdr project) <span style="color: #728a05;">:base-directory</span>)
                   folder slash (caddr specs)))
          (t
           (add-to-list '*org-pm-missing-projects* project-name)
           nil))))

<span style="color: #465a61; font-style: italic;">;; </span><span style="color: #465a61; font-style: italic;">Fix grizzl-completing-read to display custom prompt</span>
(<span style="color: #728a05;">defun</span> <span style="color: #2075c7;">grizzl-completing-read</span> (prompt index)
  <span style="color: #465a61; font-style: italic;">"Performs a completing-read in the minibuffer using INDEX to fuzzy search.</span>
<span style="color: #465a61; font-style: italic;">Each key pressed in the minibuffer filters down the list of matches."</span>
  (minibuffer-with-setup-hook
      (<span style="color: #728a05;">lambda</span> ()
        (setq *grizzl-current-result* nil)
        (setq *grizzl-current-selection* 0)
        (grizzl-mode 1)
        (<span style="color: #728a05;">lexical-let*</span>
            ((hookfun (<span style="color: #728a05;">lambda</span> ()
                        (setq *grizzl-current-result*
                              (grizzl-search (minibuffer-contents)
                                             index
                                             *grizzl-current-result*))
                        (grizzl-display-result index prompt)))
             (exitfun (<span style="color: #728a05;">lambda</span> ()
                        (grizzl-mode -1)
                        (remove-hook 'post-command-hook    hookfun t))))
          (add-hook 'minibuffer-exit-hook exitfun nil t)
          (add-hook 'post-command-hook    hookfun nil t)))
    (read-from-minibuffer (<span style="color: #728a05;">if</span> prompt prompt <span style="color: #259185;">"&gt;&gt;&gt; "</span>))
    (grizzl-selected-result index)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4-14" class="outline-3">
<h3 id="sec-4-14"><a id="ID-688C2A25-277F-4263-95C9-FFFDA2F15E87" name="ID-688C2A25-277F-4263-95C9-FFFDA2F15E87"></a>org-pm-publish: Select a project to publish from the projects targeted by current buffer.</h3>
<div class="outline-text-3" id="text-4-14">

<p>
Since a file containing org-pm tags can be anywhere outside an org-mode project folder, one cannot use org-publish-current-project to automatically provide the target project based on the file.  Therefore, use <code>org-pm-publish</code> instead to select the desired project to publish from a list of projects that are targeted by the current file.
</p>
</div>
</div>
<div id="outline-container-sec-4-15" class="outline-3">
<h3 id="sec-4-15">org-pm-enable-auto:</h3>
</div>

<div id="outline-container-sec-4-16" class="outline-3">
<h3 id="sec-4-16"><a id="ID-5D8EF403-7567-4C82-B919-37ED86C3D268" name="ID-5D8EF403-7567-4C82-B919-37ED86C3D268"></a>org-pm-disable-auto:</h3>
<div class="outline-text-3" id="text-4-16">
</div>
</div>
<div id="outline-container-sec-4-17" class="outline-3">
<h3 id="sec-4-17">org-pm-list-dupicate-project-defs</h3>
<div class="outline-text-3" id="text-4-17">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #728a05;">defun</span> <span style="color: #2075c7;">org-pm-list-duplicate-project-defs</span> ()
  <span style="color: #465a61; font-style: italic;">"List project definitions of same name that are found in more than one file or section</span><span style="color: #706f6f; background-color: #042028;">.</span>
<span style="color: #465a61; font-style: italic;">Do this in a separate org-mode buffer, and provide links to both file and section."</span>

  (interactive)

  (<span style="color: #728a05;">if</span> (equal 0 (length org-pm-project-def-duplicates))
      (<span style="color: #c60007; font-weight: bold;">error</span> <span style="color: #259185;">"There are no duplicate project definitions at all.\n!!! ... YAyyy ... !!!"</span><span style="color: #706f6f; background-color: #042028;">))</span>

  (<span style="color: #728a05;">let</span> ((buffer (get-buffer-create <span style="color: #259185;">"*org-pm-project-def-duplicates*"</span>)))
    (switch-to-buffer buffer)
    (org-mode)
    (delete-region (point-min) (point-max))
    (org-insert-heading)
    (insert <span style="color: #259185;">"DUPLICATE PROJECT DEFINITIONS"</span>)
    (<span style="color: #728a05;">dolist</span> (project org-pm-project-def-duplicates)
      (<span style="color: #728a05;">let</span> ((project-name (car project)))
        (insert <span style="color: #259185;">"\n** "</span> project-name <span style="color: #259185;">"\n"</span>)
        (<span style="color: #728a05;">dolist</span> (def (cdr project))
          (<span style="color: #728a05;">let</span> ((path-and-id (split-string def <span style="color: #259185;">"::#"</span>)))
            (insert <span style="color: #259185;">"file: file:"</span> (car path-and-id) <span style="color: #259185;">"\n"</span>)
            (insert <span style="color: #259185;">"node: "</span> <span style="color: #259185;">"id:"</span> (cadr path-and-id) <span style="color: #259185;">"\n"</span>)))))
    ))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4-18" class="outline-3">
<h3 id="sec-4-18">org-pm-list-project-defs</h3>
<div class="outline-text-3" id="text-4-18">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #728a05;">defun</span> <span style="color: #2075c7;">org-pm-list-project-defs</span> ()
  <span style="color: #465a61; font-style: italic;">"Build list of projects with links to file and node containing the project definition,</span>
<span style="color: #465a61; font-style: italic;">in a separate org-mode buffer, and provide links to both file and section.</span>
<span style="color: #465a61; font-style: italic;">Also list duplicate project definitions,</span>
<span style="color: #465a61; font-style: italic;">i.e. definitions of same name that are found in more than one file or section.</span>
<span style="color: #465a61; font-style: italic;">Note: static and combined projects created by the system</span>
<span style="color: #465a61; font-style: italic;">are not checked and added as duplicates by org-pm-check-add-project.</span>
<span style="color: #465a61; font-style: italic;">But they are in org-publish-project-alist, which we use for this list.</span>
<span style="color: #465a61; font-style: italic;">So we filter them out."</span>

  (interactive)

  (<span style="color: #728a05;">if</span> (equal 0 (length org-publish-project-alist))
      (<span style="color: #c60007; font-weight: bold;">error</span> <span style="color: #259185;">"There are no project definitions at all."</span>))

  (<span style="color: #728a05;">let</span> ((buffer (get-buffer-create <span style="color: #259185;">"*org-pm-project-definitions*"</span>))
        node-id dir)
    (switch-to-buffer buffer)
    (org-mode)
    (delete-region (point-min) (point-max))
    (org-insert-heading)
    (insert <span style="color: #259185;">"PROJECT DEFINITIONS"</span>)
    (<span style="color: #728a05;">dolist</span> (project (-remove (<span style="color: #728a05;">lambda</span> (proj)
                                (or (string-match <span style="color: #259185;">"^combined-"</span> (car proj))
                                    (string-match <span style="color: #259185;">"^static_"</span> (car proj))))
                              org-publish-project-alist))
      (setq node-id (plist-get (cdr project) <span style="color: #728a05;">:node-id</span>))
      (insert <span style="color: #259185;">"\n** "</span>
              (car project)
              <span style="color: #259185;">" (click [[elisp:(org-pm-search-link \""</span>
              (plist-get (cdr project) <span style="color: #728a05;">:project-id</span>)
              <span style="color: #259185;">"\")][*HERE*]] to edit definition)\n"</span>)
      (setq dir (plist-get (cdr project) <span style="color: #728a05;">:base-directory</span>))
      (insert <span style="color: #259185;">"base dir: [[elisp:(dired\""</span> dir <span style="color: #259185;">"\")]["</span> dir <span style="color: #259185;">"]]\n"</span> )
      (setq dir (plist-get (cdr project) <span style="color: #728a05;">:publishing-directory</span>))
      (insert <span style="color: #259185;">"publishing dir: [[elisp:(dired\""</span> dir <span style="color: #259185;">"\")]["</span> dir <span style="color: #259185;">"]]\n"</span> )
      (insert <span style="color: #259185;">"file: file:"</span> (plist-get (cdr project) <span style="color: #728a05;">:node-filename</span>) <span style="color: #259185;">"\n"</span>)
      (insert <span style="color: #259185;">"node: id:"</span> node-id <span style="color: #259185;">"\n"</span>)
      (<span style="color: #728a05;">let</span> ((duplicates (cdr (assoc (car project) org-pm-project-def-duplicates))))
        (<span style="color: #728a05;">if</span> duplicates
            (<span style="color: #728a05;">dolist</span> (def duplicates)
              (<span style="color: #728a05;">let</span> ((path-and-id (split-string def <span style="color: #259185;">"::#"</span>)))
                (insert <span style="color: #259185;">"\n*** duplicate: "</span>)
                (insert
                 <span style="color: #259185;">" (click [[elisp:(org-pm-search-link \""</span>
                 def
                 <span style="color: #259185;">"\")][*HERE*]] to edit)"</span>
                 )
                (insert <span style="color: #259185;">"\nfile: file:"</span> (car path-and-id) <span style="color: #259185;">"\n"</span>)
                (insert <span style="color: #259185;">"node: "</span> <span style="color: #259185;">"id:"</span> (cadr path-and-id) <span style="color: #259185;">"\n"</span>)))
          (insert <span style="color: #259185;">"\nThere no duplicate definitions for this project!\n"</span>))))))
</pre>
</div>
</div>

<div id="outline-container-sec-4-18-1" class="outline-4">
<h4 id="sec-4-18-1">org-pm-search-link</h4>
<div class="outline-text-4" id="text-4-18-1">
<p>
Currently, links to IDs that are not in org-link-locations are not found by org-mode.  <code>org-pm-search-link</code> finds such links by going to the file and then searching for the property with the id of the link.  It is used in org-pm-list-project-defs to enable jumping to links of duplicate project defs.  It can also be used for the same purpose in lists of components.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #728a05;">defun</span> <span style="color: #2075c7;">org-pm-search-link</span> (link)
  (<span style="color: #728a05;">let</span> ((file-and-id (split-string link <span style="color: #259185;">"::#"</span>)))
    (find-file (car file-and-id))
    (beginning-of-buffer)
    (re-search-forward (concat <span style="color: #259185;">":ID: +"</span> (cadr file-and-id)))
    (org-back-to-heading)
    (org-show-subtree)
    (org-mark-element)
    (recenter-top-bottom 1)
    (message <span style="color: #259185;">"</span>
<span style="color: #259185;">---&gt; Marked the entire section containing project definition.</span>
<span style="color: #259185;">Type C-space C-space to de-select region and deactivate mark."</span>)))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-4-19" class="outline-3">
<h3 id="sec-4-19">pm/edit-duplicate-project-def</h3>
<div class="outline-text-3" id="text-4-19">
<p>
Note: Naming this function org-pm-edit-duplicate-project-def disabled the auto-display of selections in the command line.  Something with org-mode recognizing names of functions and changing the meaning of completing-read?
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #728a05;">defun</span> <span style="color: #2075c7;">pm/edit-duplicate-project-def</span> ()
  <span style="color: #465a61; font-style: italic;">"Select a project definition from the list of found duplicates, and</span>
<span style="color: #465a61; font-style: italic;">go to the containing file at the selected location, so as to edit the</span>
<span style="color: #465a61; font-style: italic;">duplicate definition (or to remove it)."</span>

  (interactive)

  (<span style="color: #728a05;">if</span> (equal 0 (length org-pm-project-def-duplicates))
      (<span style="color: #c60007; font-weight: bold;">error</span> <span style="color: #259185;">"There are no project definitions to edit."</span>))
  (<span style="color: #728a05;">let</span> ((definitions (mapcar (<span style="color: #728a05;">lambda</span> (p) (car p)) org-pm-project-def-duplicates))
        definition def-address)
    (setq project
          (completing-read <span style="color: #259185;">"Select project: "</span> definitions nil t (car definitions)))
    (setq definitions (cdr (assoc project org-pm-project-def-duplicates)))
    (setq project
          (completing-read <span style="color: #259185;">"Select definition: "</span> definitions nil t (car definitions)))
    (setq def-address (split-string project <span style="color: #259185;">"::#"</span>))
    (find-file (car def-address))
    (beginning-of-buffer)
    (re-search-forward (concat <span style="color: #259185;">":ID: +"</span> (cadr def-address)))
    (org-back-to-heading)
    (org-show-subtree)
    (org-mark-element)
    (message <span style="color: #259185;">"</span>
<span style="color: #259185;">Marked the entire section containing duplicate project definition.</span>
<span style="color: #259185;">Type C-space C-space to de-select region and deactivate mark"</span>)
    ))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5">Keyboard shortcuts</h2>
<div class="outline-text-2" id="text-5">
<p>
Note: I use the Hyper-m  (= Mac fn key m) as prefix, because it is not likely to be occupied by other packages.  Users can easily remap.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(add-hook 'org-mode-hook
  (<span style="color: #728a05;">lambda</span> ()
    (define-key org-mode-map (kbd <span style="color: #259185;">"H-m a"</span>) 'org-pm-toggle-auto)
    (define-key org-mode-map (kbd <span style="color: #259185;">"H-m s"</span>) 'org-pm-save-and-update)
    (define-key org-mode-map (kbd <span style="color: #259185;">"H-m v"</span>) 'org-pm-toggle-verbose)
    (define-key org-mode-map (kbd <span style="color: #259185;">"H-m l"</span>) 'org-pm-list-project-defs)
    (define-key org-mode-map (kbd <span style="color: #259185;">"H-m m"</span>) 'org-pm-make-projects)
    (define-key org-mode-map (kbd <span style="color: #259185;">"H-m c"</span>) 'org-pm-copy-components-to-projects)
    (define-key org-mode-map (kbd <span style="color: #259185;">"H-m t"</span>) 'org-pm-make-project-template)))

(<span style="color: #728a05;">defun</span> <span style="color: #2075c7;">org-pm-toggle-auto</span> ()
  (interactive)
  (setq org-pm-auto-parse (not org-pm-auto-parse))
  (<span style="color: #728a05;">if</span> org-pm-auto-parse <span style="color: #465a61; font-style: italic;">;; </span><span style="color: #465a61; font-style: italic;">stay in sync with auto parse!</span>
      (setq org-pm-auto-copy 'on-save)
    (setq org-pm-auto-copy nil))
  (<span style="color: #728a05;">if</span> org-pm-auto-parse
      (message <span style="color: #259185;">"Org-pm auto-save and copy activated."</span>)
    (message <span style="color: #259185;">"Org-pm auto-save and copy deactivated."</span>)))

(<span style="color: #728a05;">defun</span> <span style="color: #2075c7;">org-pm-save-and-update</span> ()
  (interactive)
  (org-edit-src-save)
  (org-pm-make-projects)
  (org-pm-copy-components-to-projects))

(<span style="color: #728a05;">defun</span> <span style="color: #2075c7;">org-pm-toggle-verbose</span> ()
  (interactive)
  (setq org-pm-report-after-copying-p (not org-pm-report-after-copying-p))
  (<span style="color: #728a05;">if</span> org-pm-report-after-copying-p
      (message <span style="color: #259185;">"Reporting after copying activated"</span>)
    (message <span style="color: #259185;">"Reporting after copying deactivated"</span>)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6">Cleaning up duplicate links and dead projects+files</h2>
<div class="outline-text-2" id="text-6">
<ol class="org-ol">
<li>Some sections may have duplicate IDs, created by copy-pasting sections.
</li>
<li>When a project definition is copied or renamed, this may result in having duplicate definitions, i.e. multiple project definitions with the same name in different places.  Which is the one to work with.
</li>
<li>When a project definition is renamed or removed, the one stored under its previous name becomes orphaned. What to do?
</li>
<li>When a project component is deleted or moved to another project, or when the project or folder or name of the file where it should be copied changes, then the old file becomes orphaned.   What to do?
</li>
</ol>

<p>
Dealing with the above:
</p>

<ol class="org-ol">
<li>One can use org-id-update-id-locations to both find all ids and all duplicates.
</li>
<li>is possible to check as soon as it happens, because the moment a new project gets defined one can check if the already existing definition is in the same file.  Registering duplicate projects defintions in org-pm-projectd-def-duplicates.  Function org-pm-list-project-defs creates buffer listing all project defs, including duplicates, and provides links for going to any one of thse in order to edit/remove.
</li>
<li>could be delegated to commands that a user can call independently of the main specification and publishing process.
</li>
<li>could be handled like No. 3.
</li>
</ol>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: I Z</p>
<p class="date">Created: 2013-12-30 Mon 00:34</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 24.3.1 (<a href="http://orgmode.org">Org</a> mode 8.2.4)</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
